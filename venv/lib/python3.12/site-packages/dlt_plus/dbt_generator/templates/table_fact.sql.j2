/* Fact Table: {{ fact_table_name }} */
{{ "{{" }}
    config(
        materialized='incremental'
    )
{{ "}}" }}

SELECT
{%- for table in relevant_tables %}

    -- select columns for {{ table.alias }}
    {%- if loop.first %}
    ---- main table
    {%- endif %}
    {%- if table.parent_relationship %}
    ---- joined via {{ table.parent_table.alias }}.{{ table.parent_relationship.relating_table_key }}
    {%- endif %}
    {%- for c in table.render_columns %}
    {{ table.alias }}."{{ c }}" as {{ table.alias }}_{{ c }},
    {%- endfor %}
    {%- for c in table.suggested_columns %}
    -- {{ table.alias }}."{{ c }}" as {{ table.alias }}_{{ c }},
    {%- endfor %}
{%- endfor %}

FROM  {{ "{{" }} ref('{{ table_sources[fact_table_name] }}') {{ "}}" }} as {{ fact_table_name }}

{%- for table in relevant_tables %}
{%- if table.parent_relationship %}
LEFT JOIN {{ "{{" }} ref('{{ table_sources[table.name] }}') {{ "}}" }} as {{ table.alias}} ON {{ table.alias }}."{{ table.parent_relationship.related_table_key }}" = {{ table.parent_table.alias }}."{{ table.parent_relationship.relating_table_key }}"
{%- endif %}
{%- endfor %}
